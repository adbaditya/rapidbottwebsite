<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snow Glide ‚Äì Pixel Xmas Run (Downhill Edition)</title>
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Pixel Font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
        rel="stylesheet" />

  <style>

/* ==========================================
   GLOBAL RESET
========================================== */
body, html {
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: 'Press Start 2P', monospace;
  background: #0d1b2a;
  color: white;
}

canvas {
  display: block;
}

/* ==========================================
   CANVAS (Always Behind UI)
========================================== */
#gameCanvas {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;         /* behind everything */
  pointer-events: none; /* do not block menu buttons */
}


/* ==========================================
   START SCREEN UI
========================================== */
#startScreen {
  position: absolute;
  inset: 0;
  background: transparent;
  z-index: 50;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.gameTitle {
  font-size: 22px;
  margin-bottom: 25px;
  letter-spacing: 2px;
}

.menuBtn {
  margin: 8px 0;
  width: 240px;
  padding: 12px;
  border-radius: 40px;
  border: 2px solid #c9e265;
  background: rgba(255,255,255,0.05);
  color: white;
  cursor: pointer;
  transition: 0.2s ease;
}

.menuBtn:hover {
  background: rgba(201,226,101,0.25);
}


/* ==========================================
   MODALS (Base)
========================================== */
.modal {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}

.modalBox {
  background: #0d1b2a;
  width: 90%;
  max-width: 340px;
  padding: 20px;
  border-radius: 16px;
  border: 1px solid #6dc1f6;
  box-shadow: 0 0 20px rgba(0,0,0,0.65);
  position: relative;  
  z-index: 60;
}


/* ==========================================
   CHARACTER SCREEN
========================================== */
#characterScreen {
  display: none;
  position: absolute;
  inset: 0;
  z-index: 50;
  align-items: center;
  justify-content: center;
}

.characterCard {
  width: 90px;
  height: 110px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: 12px;
  padding: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  margin: 6px;
  transition: 0.2s;
}

.characterCard:hover {
  background: rgba(255,255,255,0.12);
}

.characterCard.selected {
  border: 2px solid #c9e265;
  box-shadow: 0 0 10px #c9e265;
}

.characterName {
  margin-top: 5px;
  font-size: 10px;
}


/* ==========================================
   DIFFICULTY MODAL
========================================== */
#difficultyModal {
  position: absolute;
  inset: 0;
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}

.diffBtn {
  margin: 8px 0;
  padding: 12px;
  background: rgba(255,255,255,0.05);
  border: 2px solid #6dc1f6;
  border-radius: 40px;
  text-align: center;
  cursor: pointer;
  transition: 0.2s;
}

.diffBtn:hover {
  background: rgba(201,226,101,0.25);
}


/* ==========================================
   HOW TO PLAY Modal
========================================== */
#howToPlayModal {
  display: none;
  position: absolute;
  inset: 0;
  z-index: 50;
  align-items: center;
  justify-content: center;
}


/* ==========================================
   LEADERBOARD MODAL
========================================== */
#leaderboardModal {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.75);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}

.leaderboardBox {
  background: #0d1b2a;
  width: 90%;
  max-width: 340px;
  max-height: 80%;
  overflow-y: auto;
  padding: 20px;
  border-radius: 16px;
  border: 1px solid #6dc1f6;
  box-shadow: 0 0 20px rgba(0,0,0,0.65);
  position: relative;
  z-index: 60;
}

.modalTitle {
  font-size: 16px;
  font-weight: bold;
  text-align: center;
  margin-bottom: 12px;
  color: #c9e265;
}

/* Row styles */
.leaderboardList {
  width: 100%;
}

.lbRow {
  display: flex;
  justify-content: space-between;
  padding: 8px 10px;
  margin-bottom: 6px;
  background: rgba(255,255,255,0.06);
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.08);
  font-size: 12px;
}

.lbRow:hover {
  background: rgba(255,255,255,0.12);
}

.lbRank {
  font-weight: bold;
  color: #6dc1f6;
}

.lbName {
  flex: 1;
  text-align: center;
}

.lbScore {
  color: #c9e265;
}


/* ==========================================
   PAUSE & GAME OVER
========================================== */
#pauseOverlay,
#gameOverCard,
#nameEntryModal {
  position: absolute;
  inset: 0;
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}


/* ==========================================
   TOAST (Feedback Notification)
========================================== */
.toast {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  padding: 10px 16px;
  border-radius: 999px;
  font-size: 10px;
  opacity: 0;
  z-index: 70;
  transition: opacity 0.3s ease;
}

.toast.show {
  opacity: 1;
}


/* ==========================================
   FINAL UI PATCH (Ensures buttons work)
========================================== */
#startScreen,
#characterScreen,
#leaderboardModal,
#difficultyModal,
#howToPlayModal,
#pauseOverlay,
#gameOverCard,
#nameEntryModal {
  z-index: 50;
  pointer-events: auto;
}

.modalBox,
.leaderboardBox,
.pauseBox,
.gameOverBox,
.nameEntryBox {
  z-index: 60;
}

</style>

</head>


<body>

<!-- GAME CANVAS -->
<canvas id="gameCanvas"></canvas>
<img id="playerSprite" src="" alt="player" />

<!-- ============================
     START SCREEN (with Difficulty)
     ============================ -->
<div id="startScreen">
  <div id="soundToggleMain" class="soundToggle" onclick="toggleSound()"></div>

  <div>
    <div class="title">‚ùÑ SNOW GLIDE ‚ùÑ<br/>PIXEL XMAS RUN</div>

    <div class="btn" onclick="playUiClick(); openCharacterSelect()">PLAY GAME</div>
    <div class="btn secondary" onclick="playUiClick(); openHowToPlay()">HOW TO PLAY</div>
    <div class="btn secondary" onclick="playUiClick(); openLeaderboard()">LEADERBOARD</div>

    <!-- NEW DIFFICULTY BUTTON -->
    <div class="btn secondary" onclick="playUiClick(); openDifficultyModal()">DIFFICULTY</div>

    <div class="subtitle" style="margin-top:16px;">
      Endless downhill skating through a winter wonderland.
    </div>
  </div>

  <div class="byText">By Rapidbott</div>
</div>

<!-- ================================
     CHARACTER SELECTION SCREEN
     ================================ -->
<div id="characterScreen">
  <div id="soundToggleChar" class="soundToggle" onclick="toggleSound()"></div>

  <div class="title">SELECT YOUR SKATER</div>

  <!-- Character Grid -->
  <div id="characterGrid"
       style="display:flex;flex-wrap:wrap;justify-content:center;gap:18px;margin-top:10px;">
    <!-- Characters injected by JS -->
  </div>

  <!-- NEW DIFFICULTY BUTTON INSIDE CHARACTER SCREEN -->
  <div class="btn secondary"
       style="margin-top:24px;"
       onclick="playUiClick(); openDifficultyModal()">
       DIFFICULTY
  </div>

  <!-- Confirm Character -->
  <div class="btn" style="margin-top:20px;" onclick="playUiClick(); startGameFromCharacter()">
    START GAME
  </div>

  <div class="byText">By Rapidbott</div>
</div>



<!-- ================================
     DIFFICULTY SELECT MODAL (D-UI3)
     ================================ -->
<div id="difficultyModal" class="difficultyModalOverlay">
  <div class="difficultyModalBox">

    <div class="difficultyClose" onclick="closeDifficultyModal()">‚úï</div>

    <div class="difficultyModalTitle">
      SELECT DIFFICULTY
    </div>

    <!-- AUTO MODE -->
    <div class="difficultyOption" id="difficulty_auto"
         onclick="selectDifficulty('auto')">
      ‚ùÑ AUTO (Adaptive)
      <div style="font-size:9px;margin-top:6px;opacity:0.8;">
        Difficulty adjusts dynamically based on your skill.
      </div>
    </div>

    <!-- EASY -->
    <div class="difficultyOption" id="difficulty_easy"
         onclick="selectDifficulty('easy')">
      üê• EASY
      <div style="font-size:9px;margin-top:6px;opacity:0.8;">
        Slow downhill speed. Great for beginners.
      </div>
    </div>

    <!-- MEDIUM -->
    <div class="difficultyOption" id="difficulty_medium"
         onclick="selectDifficulty('medium')">
      ‚õ∞Ô∏è MEDIUM
      <div style="font-size:9px;margin-top:6px;opacity:0.8;">
        The balanced Snow Glide experience.
      </div>
    </div>

    <!-- HARD -->
    <div class="difficultyOption" id="difficulty_hard"
         onclick="selectDifficulty('hard')">
      üî• HARD
      <div style="font-size:9px;margin-top:6px;opacity:0.8;">
        Fast, intense, challenging. Only for pros!
      </div>
    </div>

  </div>
</div>



<!-- ================================
     HOW TO PLAY MODAL
     ================================ -->
<div id="howToPlayModal"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);
            z-index:50;align-items:center;justify-content:center;padding:16px;">

  <div style="background:#0d1b2a;border-radius:18px;max-width:360px;width:100%;
              padding:20px;color:white;border:1px solid #6dc1f6;
              box-shadow:0 0 30px rgba(0,0,0,0.8);text-align:center;">

    <div style="font-size:14px;margin-bottom:10px;text-shadow:0 0 6px #6dc1f6;">
      HOW TO PLAY
    </div>

    <div style="font-size:10px;line-height:1.5;">
      ‚Ä¢ Drag left or right to move your skater.<br><br>
      ‚Ä¢ Avoid trees, ice golems & rolling snowballs.<br><br>
      ‚Ä¢ Collect green gifts for bonus score.<br><br>
      ‚Ä¢ The longer you survive, the faster the downhill becomes.<br><br>
      Good luck!
    </div>

    <div class="btn" style="margin-top:16px;" onclick="closeHowToPlay()">OK</div>
  </div>
</div>



<!-- ================================
     LEADERBOARD MODAL
     ================================ -->
<div id="leaderboardModal"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);
            z-index:55;align-items:center;justify-content:center;padding:16px;">

  <div style="background:#0d1b2a;border-radius:18px;max-width:380px;width:100%;
              padding:20px;color:white;border:1px solid #6dc1f6;
              box-shadow:0 0 30px rgba(0,0,0,0.8);max-height:80vh;overflow-y:auto;">

    <div style="font-size:14px;margin-bottom:10px;text-shadow:0 0 6px #6dc1f6;">
      LEADERBOARD
    </div>

    <div id="leaderboardList" style="font-size:10px;line-height:1.8;">
      <!-- Entries will be injected by JS -->
    </div>

    <div class="btn" style="margin-top:16px;" onclick="closeLeaderboard()">OK</div>
  </div>
</div>

<style>
/* ======================================
   CHARACTER GRID STYLING
====================================== */
.characterCard {
  width: 90px;
  height: 110px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: 12px;
  padding: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.characterCard:hover {
  background: rgba(255,255,255,0.08);
}

.characterCard.selected {
  border: 2px solid #c9e265;
  box-shadow: 0 0 10px rgba(201,226,101,0.7);
  background: rgba(255,255,255,0.12);
}

.characterCard img {
  width: 60px;
  height: 60px;
  image-rendering: pixelated;
}

.characterName {
  font-size: 9px;
  margin-top: 6px;
  color: #ffffff;
  opacity: 0.9;
}


/* ======================================
   SCORE + LIVES UI DURING GAMEPLAY
====================================== */
#scoreUI {
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 14px;
  color: #ffffff;
  text-shadow: 0 0 5px #000;
  z-index: 20;
  display: none;
}

#livesUI {
  position: absolute;
  top: 12px;
  left: 12px;
  font-size: 14px;
  color: #ffffff;
  text-shadow: 0 0 5px #000;
  z-index: 20;
  display: none;
}


/* ======================================
   PAUSE + RESUME OVERLAY
====================================== */
#pauseOverlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.55);
  z-index: 30;
  display: none;
  align-items: center;
  justify-content: center;
}

.pauseBox {
  background: #0d1b2a;
  padding: 20px;
  border-radius: 16px;
  text-align: center;
  border: 1px solid #6dc1f6;
  color: white;
  width: 220px;
  box-shadow: 0 0 30px rgba(0,0,0,0.8);
}

.pauseBox .title {
  font-size: 14px;
  margin-bottom: 10px;
}

.pauseBtn {
  margin-top: 12px;
  background: linear-gradient(135deg,#c9e265,#6dc1f6);
  padding: 10px;
  border-radius: 999px;
  cursor: pointer;
}


/* ======================================
   GAME OVER SCORE CARD
====================================== */
#gameOverCard {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.65);
  z-index: 40;
  display: none;
  align-items: center;
  justify-content: center;
}

.gameOverBox {
  background: #0d1b2a;
  padding: 24px;
  width: 260px;
  border-radius: 16px;
  text-align: center;
  border: 1px solid #6dc1f6;
  color: white;
  box-shadow: 0 0 25px rgba(0,0,0,0.7);
}

.gameOverBox .title {
  font-size: 14px;
}

.gameOverScore {
  font-size: 12px;
  margin-top: 12px;
  margin-bottom: 18px;
  text-shadow: 0 0 6px #c9e265;
}

.gameOverBtn {
  background: linear-gradient(135deg,#c9e265,#6dc1f6);
  padding: 12px;
  border-radius: 999px;
  margin-top: 12px;
  cursor: pointer;
}


/* ======================================
   NAME ENTRY MODAL (FOR LEADERBOARD)
====================================== */
#nameEntryModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 70;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

.nameEntryBox {
  background: #0d1b2a;
  padding: 20px;
  border-radius: 18px;
  max-width: 320px;
  width: 100%;
  color: white;
  border: 1px solid #6dc1f6;
  box-shadow: 0 0 30px rgba(0,0,0,0.8);
  text-align: center;
}

.nameEntryBox input {
  width: 90%;
  padding: 10px;
  margin-top: 12px;
  border-radius: 8px;
  outline: none;
  border: none;
  background: rgba(255,255,255,0.1);
  color: white;
  font-size: 12px;
}

.nameEntryBox .btn {
  margin-top: 16px;
}


/* ======================================
   NOTIFICATION / TOAST POPUP
====================================== */
.toast {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  padding: 10px 16px;
  border-radius: 999px;
  color: white;
  font-size: 10px;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 90;
}

.toast.show {
  opacity: 1;
}


/* ======================================
   MISC UI LABELS
====================================== */

#speedIndicator {
  position: absolute;
  bottom: 20px;
  right: 14px;
  font-size: 10px;
  color: #ffffff;
  opacity: 0.8;
  z-index: 25;
}

#distanceIndicator {
  position: absolute;
  bottom: 20px;
  left: 14px;
  font-size: 10px;
  color: #ffffff;
  opacity: 0.8;
  z-index: 25;
}


/* ==========================================
   LEADERBOARD MODAL
========================================== */

#leaderboardModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  z-index: 70;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

.leaderboardBox {
  background: #0d1b2a;
  width: 90%;
  max-width: 340px;
  max-height: 80%;
  overflow-y: auto;
  padding: 20px;
  border-radius: 16px;
  border: 1px solid #6dc1f6;
  box-shadow: 0 0 20px rgba(0,0,0,0.65);
  color: white;
}

.modalTitle {
  font-size: 16px;
  font-weight: bold;
  text-align: center;
  margin-bottom: 12px;
  color: #c9e265;
}

/* Leaderboard rows */
.leaderboardList {
  width: 100%;
}

.lbRow {
  display: flex;
  justify-content: space-between;
  padding: 8px 10px;
  margin-bottom: 6px;
  background: rgba(255,255,255,0.06);
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.08);
  font-size: 12px;
}

.lbRow:hover {
  background: rgba(255,255,255,0.12);
}

.lbRank {
  font-weight: bold;
  color: #6dc1f6;
}

.lbName {
  flex: 1;
  text-align: center;
  color: #ffffff;
}

.lbScore {
  color: #c9e265;
}

/* Back button styling */
.backBtn {
  margin-top: 16px;
  text-align: center;
  padding: 10px;
  background: linear-gradient(135deg, #c9e265, #6dc1f6);
  color: #0d1b2a;
  border-radius: 999px;
  cursor: pointer;
}



</style>


<!-- ==========================================
     PAUSE OVERLAY
========================================== -->
<div id="pauseOverlay">
  <div class="pauseBox">
    <div class="title">GAME PAUSED</div>
    <div class="pauseBtn" onclick="resumeGame()">RESUME</div>
    <div class="pauseBtn" onclick="quitToMenu()">QUIT</div>
  </div>
</div>


<!-- ==========================================
     GAME OVER CARD
========================================== -->
<div id="gameOverCard">
  <div class="gameOverBox">
    <div class="title">GAME OVER</div>

    <div id="finalScoreText" class="gameOverScore">
      Your Score: 0
    </div>

    <div class="gameOverBtn" onclick="retryGame()">RETRY</div>
    <div class="gameOverBtn" onclick="openNameEntry()">SAVE SCORE</div>
    <div class="gameOverBtn" onclick="quitToMenu()">MAIN MENU</div>
  </div>
</div>


<!-- ==========================================
     NAME ENTRY (LEADERBOARD SUBMISSION)
========================================== -->
<div id="nameEntryModal">
  <div class="nameEntryBox">
    <div class="title">ENTER YOUR NAME</div>

    <input id="playerNameInput" 
           type="text"
           placeholder="Your Name"
           maxlength="12" />

    <div class="btn" onclick="submitScore()">SUBMIT</div>
  </div>
</div>


<!-- ==========================================
     TOAST NOTIFICATION
========================================== -->
<div id="toast" class="toast"></div>


<!-- ==========================================
     SCORE UI OVERLAYS
========================================== -->
<div id="scoreUI">0</div>
<div id="livesUI">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
<div id="speedIndicator"></div>
<div id="distanceIndicator"></div>


<!-- ==========================================
     LEADERBOARD MODAL
========================================== -->
<div id="leaderboardModal" class="modal">
  <div class="modalBox leaderboardBox">

    <div class="modalTitle">Leaderboard</div>

    <div id="leaderboardList" class="leaderboardList"></div>

    <div class="backBtn">Back</div>
  </div>
</div>



<!-- ==========================================
     END OF HTML ‚Äî JS WILL BEGIN BELOW
========================================== -->

<!-- JS begins in PART 2 -->
<script>

/* ==========================================
   CANVAS SETUP
========================================== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);


/* ==========================================
   GAME STATE
========================================== */
let gameRunning = false;
let gameOver = false;
let paused = false;

let score = 0;
let distance = 0;
let lives = 3;

let worldSpeed = 3;
let baseSpeed = 2.2;

let autoDifficultyLevel = 0;
let difficultyMode = "auto";


/* ==========================================
   PLAYER
========================================== */
const player = {
  x: 0,
  y: 0,
  width: 80,
  height: 80,
  speedX: 0,
  speedY: 0
};

function resetPlayerPosition() {
  player.x = canvas.width / 2 - player.width / 2;
  player.y = canvas.height * 0.15;
}


/* ==========================================
   INPUT
========================================== */
const keys = { left: false, right: false, up: false, down: false };
window.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft") keys.left = true;
  if (e.key === "ArrowRight") keys.right = true;
  if (e.key === "ArrowUp") keys.up = true;
  if (e.key === "ArrowDown") keys.down = true;
  if (e.key === "Escape") togglePause();
});
window.addEventListener("keyup", e => {
  if (e.key === "ArrowLeft") keys.left = false;
  if (e.key === "ArrowRight") keys.right = false;
  if (e.key === "ArrowUp") keys.up = false;
  if (e.key === "ArrowDown") keys.down = false;
});

/* Touch */
let touchActive = false;
let lastTouchPos = null;

window.addEventListener("touchstart", e => {
  touchActive = true;
});
window.addEventListener("touchend", e => {
  touchActive = false;
});
window.addEventListener("touchmove", e => {
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  lastTouchPos = {
    x: t.clientX - rect.left,
    y: t.clientY - rect.top
  };
  e.preventDefault();
}, { passive: false });


/* ==========================================
   AUTO DIFFICULTY (M3)
========================================== */
function updateAutoDifficulty() {
  if (difficultyMode !== "auto") return;

  autoDifficultyLevel += 0.00025;
  if (autoDifficultyLevel > 2.5) autoDifficultyLevel = 2.5;
}

function computeWorldSpeed() {
  if (difficultyMode === "easy") return 2.2;
  if (difficultyMode === "medium") return 3.3;
  if (difficultyMode === "hard") return 4.6;

  return baseSpeed + autoDifficultyLevel;
}


/* ==========================================
   WORLD & SCORE
========================================== */
let worldOffset = 0;

function updateWorld(dt) {
  worldSpeed = computeWorldSpeed();
  worldOffset += worldSpeed;

  distance += worldSpeed * 0.02;
  score = Math.floor(distance);

  updateHUD();
}

function updateHUD() {
  document.getElementById("scoreUI").innerHTML = score + " m";
  document.getElementById("livesUI").innerHTML = "‚ù§Ô∏è".repeat(lives);
}


/* ==========================================
   PLAYER MOVEMENT
========================================== */
function updatePlayer(dt) {
  const moveSpeed = 420 * dt;

  if (keys.left) player.x -= moveSpeed;
  if (keys.right) player.x += moveSpeed;
  if (keys.up) player.y -= moveSpeed * 0.7;
  if (keys.down) player.y += moveSpeed;

  if (touchActive && lastTouchPos) {
    const dx = lastTouchPos.x - (player.x + player.width / 2);
    const dy = lastTouchPos.y - (player.y + player.height / 2);
    player.x += dx * 0.25;
    player.y += dy * 0.25;
  }

  if (player.x < 0) player.x = 0;
  if (player.x + player.width > canvas.width)
    player.x = canvas.width - player.width;

  if (player.y < 0) player.y = 0;
  if (player.y + player.height > canvas.height)
    player.y = canvas.height - player.height;
}


/* ==========================================
   TRAIL
========================================== */
let trail = [];

function updateTrail(dt) {
  trail.push({
    x: player.x + player.width / 2,
    y: player.y + player.height
  });

  if (trail.length > 160) trail.shift();

  const trailSpeed = worldSpeed * 0.45;
  for (let p of trail) {
    p.y += trailSpeed;
  }
}

function drawTrail() {
  if (trail.length < 2) return;

  ctx.lineCap = "round";
  ctx.lineWidth = 7;
  ctx.strokeStyle = "rgba(109,193,246,0.9)";

  ctx.beginPath();
  for (let i = 0; i < trail.length; i++) {
    const p = trail[i];
    if (i === 0) ctx.moveTo(p.x, p.y);
    else ctx.lineTo(p.x, p.y);
  }
  ctx.stroke();
}


/* ==========================================
   BACKGROUND
========================================== */
function drawBackground() {
  const h = canvas.height;
  const g = ctx.createLinearGradient(0, 0, 0, h);
  g.addColorStop(0, "#4fa3e3");
  g.addColorStop(1, "#d8f2ff");
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}


/* ==========================================
   HITBOX
========================================== */
function getPlayerHitbox() {
  return {
    x: player.x + player.width * 0.2,
    y: player.y + player.height * 0.2,
    w: player.width * 0.6,
    h: player.height * 0.6
  };
}


/* ==========================================
   OBSTACLES (TREES)
========================================== */
let obstacles = [];
let obstacleTimer = 0;

function spawnObstacle() {
  const w = 48;
  const h = 80;
  const margin = 60;
  const x = margin + Math.random() * (canvas.width - margin * 2 - w);

  obstacles.push({ x, y: -100, w, h });
}

function scaledObstacleRate() {
  return Math.max(28 - autoDifficultyLevel * 3, 14);
}

function updateObstacles(dt) {
  const speed = worldSpeed * 1.0;
  obstacleTimer += dt * worldSpeed;

  if (obstacleTimer > scaledObstacleRate()) {
    spawnObstacle();
    obstacleTimer = 0;
  }

  const hitbox = getPlayerHitbox();

  for (let i = obstacles.length - 1; i >= 0; i--) {
    const o = obstacles[i];
    o.y += speed;

    if (rectsOverlap(hitbox, o)) {
      obstacles.splice(i, 1);
      lifeLost();
      continue;
    }

    if (o.y > canvas.height + 100) obstacles.splice(i, 1);
  }
}

function drawObstacles() {
  obstacles.forEach(o => {
    ctx.fillStyle = "#7d4b27";
    ctx.fillRect(o.x + o.w * 0.4, o.y + o.h * 0.65, o.w * 0.2, o.h * 0.35);

    ctx.fillStyle = "#276b47";
    ctx.beginPath();
    ctx.moveTo(o.x + o.w / 2, o.y);
    ctx.lineTo(o.x, o.y + o.h * 0.8);
    ctx.lineTo(o.x + o.w, o.y + o.h * 0.8);
    ctx.closePath();
    ctx.fill();
  });
}


/* ==========================================
   GIFTS
========================================== */
let gifts = [];
let giftTimer = 0;

function spawnGift() {
  const w = 40;
  const h = 40;
  const margin = 40;
  const x = margin + Math.random() * (canvas.width - margin * 2 - w);
  const type = Math.random() < 0.75 ? "points" : "life";

  gifts.push({ x, y: -100, w, h, type });
}

function scaledGiftRate() {
  return Math.max(58 - autoDifficultyLevel * 2, 32);
}

function updateGifts(dt) {
  const speed = worldSpeed * 1.0;
  giftTimer += dt * worldSpeed;

  if (giftTimer > scaledGiftRate()) {
    spawnGift();
    giftTimer = 0;
  }

  const hitbox = getPlayerHitbox();

  for (let i = gifts.length - 1; i >= 0; i--) {
    const g = gifts[i];
    g.y += speed;

    if (rectsOverlap(hitbox, g)) {
      if (g.type === "points") score += 150;
      if (navigator.vibrate) navigator.vibrate(80);
      if (g.type === "life" && lives < 3) lives++;
      gifts.splice(i, 1);
      continue;
    }

    if (g.y > canvas.height + 80) gifts.splice(i, 1);
  }
}

function drawGifts() {
  gifts.forEach(g => {
    ctx.fillStyle = g.type === "points" ? "#c9e265" : "#ff3b6a";
    ctx.fillRect(g.x, g.y, g.w, g.h);

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(g.x + g.w / 2 - 3, g.y, 6, g.h);
    ctx.fillRect(g.x, g.y + g.h / 2 - 3, g.w, 6);
  });
}


/* ==========================================
   SNOWBALLS
========================================== */
let bigSnowballs = [];
let bigSnowballTimer = 0;

function spawnBigSnowball() {
  const r = 48;
  const x = r + Math.random() * (canvas.width - r * 2);
  const vx = (Math.random() - 0.5) * 1.2;
  bigSnowballs.push({ x, y: -120, r, vx });
}

function scaledSnowballRate() {
  return Math.max(115 - autoDifficultyLevel * 5, 60);
}

function updateBigSnowballs(dt) {
  const fall = worldSpeed * 1.1;
  bigSnowballTimer += dt * worldSpeed;

  if (bigSnowballTimer > scaledSnowballRate()) {
    spawnBigSnowball();
    bigSnowballTimer = 0;
  }

  const hitbox = getPlayerHitbox();

  for (let i = bigSnowballs.length - 1; i >= 0; i--) {
    const b = bigSnowballs[i];
    b.y += fall;
    b.x += b.vx;

    if (circleRectOverlap(b, hitbox)) {
      bigSnowballs.splice(i, 1);
      lifeLost();
      continue;
    }

    if (b.y > canvas.height + b.r) bigSnowballs.splice(i, 1);
  }
}

function drawBigSnowballs() {
  bigSnowballs.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
  });
}


/* ==========================================
   GOLEMS + PROJECTILES
========================================== */
let golems = [];
let golemTimer = 0;
let golemBullets = [];

function spawnGolem() {
  golems.push({
    x: 40 + Math.random() * (canvas.width - 80),
    y: -160,
    w: 70,
    h: 90,
    shootCooldown: 1 + Math.random() * 1.5
  });
}

function scaledGolemRate() {
  return Math.max(190 - autoDifficultyLevel * 6, 90);
}

function updateGolems(dt) {
  const fall = worldSpeed * 0.9;
  golemTimer += dt * worldSpeed;

  if (golemTimer > scaledGolemRate()) {
    spawnGolem();
    golemTimer = 0;
  }

  const hitbox = getPlayerHitbox();

  for (let i = golems.length - 1; i >= 0; i--) {
    const g = golems[i];
    g.y += fall;

    if (rectsOverlap(hitbox, g)) {
      golems.splice(i, 1);
      lifeLost();
      continue;
    }

    g.shootCooldown -= dt;
    if (g.shootCooldown <= 0) {
      fireGolemSnowball(g);
      g.shootCooldown = 1.2 + Math.random() * 1.2;
    }

    if (g.y > canvas.height + 120) golems.splice(i, 1);
  }
}

function drawGolems() {
  golems.forEach(g => {
    ctx.fillStyle = "#88caff";
    ctx.fillRect(g.x, g.y, g.w, g.h);
  });
}


/* PROJECTILES */
function fireGolemSnowball(g) {
  const px = player.x + player.width / 2;
  const py = player.y + player.height / 2;

  const ox = g.x + g.w / 2;
  const oy = g.y;

  let dx = px - ox;
  let dy = py - oy;

  const mag = Math.sqrt(dx * dx + dy * dy) || 1;
  dx /= mag;
  dy /= mag;

  const speed = 300 + worldSpeed * 40;

  golemBullets.push({ x: ox, y: oy, r: 14, vx: dx * speed, vy: dy * speed });
}

function updateGolemBullets(dt) {
  const hitbox = getPlayerHitbox();

  for (let i = golemBullets.length - 1; i >= 0; i--) {
    const b = golemBullets[i];
    b.x += b.vx * dt;
    b.y += b.vy * dt;

    if (circleRectOverlap(b, hitbox)) {
      golemBullets.splice(i, 1);
      lifeLost();
      continue;
    }

    if (b.y > canvas.height + 50 ||
        b.x < -50 || b.x > canvas.width + 50) {
      golemBullets.splice(i, 1);
    }
  }
}

function drawGolemBullets() {
  golemBullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
  });
}


/* ==========================================
   COLLISION HELPERS
========================================== */
function rectsOverlap(a, b) {
  return (
    a.x < b.x + b.w &&
    a.x + a.w > b.x &&
    a.y < b.y + b.h &&
    a.y + a.h > b.y
  );
}

function circleRectOverlap(circle, rect) {
  const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.w));
  const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.h));

  const dx = circle.x - closestX;
  const dy = circle.y - closestY;

  return dx * dx + dy * dy < circle.r * circle.r;
}


/* ==========================================
   DAMAGE FX & INVINCIBILITY
========================================== */
let invincible = false;
let invincibleTimer = 0;
let flashOpacity = 0;
let screenShake = 0;

function lifeLost() {
  if (invincible) return;

  lives--;
  if (navigator.vibrate) navigator.vibrate(150);

  flashOpacity = 0.6;
  screenShake = 12;

  invincible = true;
  invincibleTimer = 1;

  if (lives <= 0) triggerGameOver();
}

function updateInvincibility(dt) {
  if (!invincible) return;
  invincibleTimer -= dt;
  if (invincibleTimer <= 0) invincible = false;
}

function drawDamageFlash() {
  if (flashOpacity > 0) {
    ctx.fillStyle = `rgba(255,0,0,${flashOpacity})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    flashOpacity -= 0.02;
  }
}

function applyScreenShake() {
  if (screenShake > 0) {
    const dx = (Math.random() - 0.5) * screenShake;
    const dy = (Math.random() - 0.5) * screenShake;
    ctx.translate(dx, dy);
    screenShake *= 0.85;
  }
}


/* ==========================================
   RENDER ORDER
========================================== */
function drawPlayer() {
  ctx.fillStyle = "#ff3366"; // placeholder
  ctx.fillRect(player.x, player.y, player.width, player.height);
}

function renderFrame() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawBackground();
  drawTrail();
  drawObstacles();
  drawGifts();
  drawBigSnowballs();
  drawGolems();
  drawGolemBullets();
  drawPlayer();
  drawDamageFlash();
}


/* ==========================================
   GAME LOOP
========================================== */
let lastTimestamp = 0;

function gameLoop(timestamp) {
  if (!gameRunning) return;

  const dt = (timestamp - lastTimestamp) / 1000;
  lastTimestamp = timestamp;

  if (!paused) {
    updateAutoDifficulty();
    updateInvincibility(dt);
    updateWorld(dt);
    updatePlayer(dt);
    updateTrail(dt);
    updateObstacles(dt);
    updateGifts(dt);
    updateBigSnowballs(dt);
    updateGolems(dt);
    updateGolemBullets(dt);
  }

  ctx.save();
  applyScreenShake();
  renderFrame();
  ctx.restore();

  requestAnimationFrame(gameLoop);
}


/* ==========================================
   GAME START / PAUSE / GAME OVER
========================================== */
function startGame() {
  document.getElementById("gameCanvas").style.pointerEvents = "auto";

  score = 0;
  distance = 0;
  lives = 3;
  autoDifficultyLevel = 0;

  obstacles = [];
  gifts = [];
  bigSnowballs = [];
  golems = [];
  golemBullets = [];
  trail = [];

  resetPlayerPosition();

  document.getElementById("startScreen").style.display = "none";
  document.getElementById("characterScreen").style.display = "none";
  document.getElementById("leaderboardModal").style.display = "none";
  document.getElementById("gameOverCard").style.display = "none";

  gameRunning = true;
  paused = false;

  lastTimestamp = performance.now();
  requestAnimationFrame(gameLoop);
}

function togglePause() {
  if (!gameRunning) return;
  paused = !paused;

  document.getElementById("pauseOverlay").style.display = paused ? "flex" : "none";
}

function resumeGame() {
  paused = false;
  document.getElementById("pauseOverlay").style.display = "none";
}

function triggerGameOver() {
  gameRunning = false;
  paused = false;

  document.getElementById("finalScoreText").innerHTML = "Your Score: " + score + " m";
  document.getElementById("gameOverCard").style.display = "flex";

  handleAutoLeaderboardSubmit();
}

function retryGame() {
  startGame();
}

function quitToMenu() {
  gameRunning = false;
  paused = false;
  showMenu();
}


/* ==========================================
   CHARACTER SYSTEM
========================================== */
let selectedCharacter = localStorage.getItem("snowglide_character") || "default";

function selectCharacter(name) {
  selectedCharacter = name;
  localStorage.setItem("snowglide_character", name);

  document.querySelectorAll(".characterCard").forEach(c => {
    c.classList.remove("selected");
    if (c.dataset.char === name) c.classList.add("selected");
  });

  showToast("Character Selected: " + name);
}

function loadSavedCharacterSelection() {
  document.querySelectorAll(".characterCard").forEach(c => {
    c.classList.remove("selected");
    if (c.dataset.char === selectedCharacter) c.classList.add("selected");
  });
}


/* ==========================================
   DIFFICULTY UI
========================================== */
function chooseDifficulty(mode) {
  difficultyMode = mode;
  localStorage.setItem("snowglide_difficulty", mode);
  showToast("Difficulty: " + mode.toUpperCase());
  closeDifficultyModal();
}

function loadSavedDifficulty() {
  const d = localStorage.getItem("snowglide_difficulty");
  if (d) difficultyMode = d;
}


/* ==========================================
   MENU NAV
========================================== */
function openCharacterScreen() {
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("characterScreen").style.display = "flex";
  loadSavedCharacterSelection();
}

function openDifficultyModal() {
  document.getElementById("difficultyModal").style.display = "flex";
}
function closeDifficultyModal() {
  document.getElementById("difficultyModal").style.display = "none";
}

function openHowToPlay() {
  document.getElementById("howToPlayModal").style.display = "flex";
}

function closeHowToPlay() {
  document.getElementById("howToPlayModal").style.display = "none";
}

function showMenu() {
  document.getElementById("startScreen").style.display = "flex";
  document.getElementById("gameCanvas").style.pointerEvents = "none";
}


/* ==========================================
   TOAST
========================================== */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.innerHTML = msg;
  t.style.opacity = "1";
  setTimeout(() => t.style.opacity = "0", 1800);
}


/* ==========================================
   UNIQUE DEVICE ID
========================================== */
function getDeviceID() {
  let id = localStorage.getItem("snowglide_device_id");
  if (!id) {
    id = "dev-" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("snowglide_device_id", id);
  }
  return id;
}
const deviceID = getDeviceID();


/* ==========================================
   LEADERBOARD SYSTEM
========================================== */

const API_BASE     = "https://YOUR_API_URL";
const API_SUBMIT   = API_BASE + "/leaderboard/submit";
const API_FETCH    = API_BASE + "/leaderboard/list";

function getBestScore() {
  return Number(localStorage.getItem("snowglide_best_score") || 0);
}

function updateBestScore(score) {
  const best = getBestScore();
  if (score > best) {
    localStorage.setItem("snowglide_best_score", score);
    return true;
  }
  return false;
}

async function submitScoreToServer(name, score) {
  try {
    await fetch(API_SUBMIT, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        "x-device-id": deviceID
      },
      body: JSON.stringify({ name, score })
    });
  } catch (err) {
    console.error("Submit error:", err);
  }
}

async function handleAutoLeaderboardSubmit() {
  const playerName = localStorage.getItem("snowglide_player_name");

  if (!playerName) {
    openNameEntry();
    return;
  }

  if (updateBestScore(score)) {
    await submitScoreToServer(playerName, score);
  }
}

function openNameEntry() {
  document.getElementById("nameEntryModal").style.display = "flex";
}

async function submitScore() {
  const input = document.getElementById("playerNameInput");
  const name = input.value.trim();

  if (!name) {
    showToast("Enter a name");
    return;
  }

  localStorage.setItem("snowglide_player_name", name);
  updateBestScore(score);
  await submitScoreToServer(name, score);

  document.getElementById("nameEntryModal").style.display = "none";
  showToast("Score saved!");
}

async function loadLeaderboard() {
  try {
    const res = await fetch(API_FETCH, {
      headers: { "x-device-id": deviceID }
    });
    const data = await res.json();
    renderLeaderboard(data.entries);
  } catch (err) {
    console.error("Leaderboard load error:", err);
  }
}

function renderLeaderboard(entries) {
  const list = document.getElementById("leaderboardList");
  list.innerHTML = "";
  const best = getBestScore();

  entries.forEach((row, i) => {
    const div = document.createElement("div");
    div.className = "lbRow";

    if (row.deviceID === deviceID && row.score === best) {
      div.style.background = "rgba(201,226,101,0.2)";
      div.style.border = "1px solid #c9e265";
      div.style.boxShadow = "0 0 10px #c9e265";
    }

    div.innerHTML =
      `<span class="lbRank">#${i + 1}</span>
       <span class="lbName">${row.name}</span>
       <span class="lbScore">${row.score}</span>`;

    list.appendChild(div);
  });
}

function openLeaderboardModal() {
  document.getElementById("leaderboardModal").style.display = "flex";
  loadLeaderboard();
}

function closeLeaderboardModal() {
  document.getElementById("leaderboardModal").style.display = "none";
  showMenu();
}


/* ==========================================
   BUTTON HOOKS
========================================== */
document.getElementById("playBtn")?.addEventListener("click", () => startFromMenu());
document.getElementById("leaderboardBtn")?.addEventListener("click", () => openLeaderboardModal());
document.getElementById("difficultyBtn")?.addEventListener("click", () => openDifficultyModal());
document.getElementById("characterBtn")?.addEventListener("click", () => openCharacterScreen());
document.getElementById("howBtn")?.addEventListener("click", () => openHowToPlay());

document.querySelectorAll(".backBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    closeCharacterScreen?.();
    closeLeaderboardModal?.();
    closeDifficultyModal?.();
    closeHowToPlay?.();
    showMenu();
  });
});

document.querySelectorAll(".characterCard").forEach(card => {
  card.addEventListener("click", () => selectCharacter(card.dataset.char));
});


/* ==========================================
   SHOW MENU ON LOAD
========================================== */
window.onload = () => {
  loadSavedCharacterSelection();
  loadSavedDifficulty();
  showMenu();
};

</script>


</body>
</html>
